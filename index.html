<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #145A32; --gold: #D4AC0D; --bg: #F9F9F3; --btn-bg: #ecf0f1; --dark: #2c3e50; }
        
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--bg); margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; padding-bottom: 240px;
            min-height: 100vh;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%;
            width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(20, 90, 50, 0.2);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-screen { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; text-align: center; }
        .login-box {
            background: white; padding: 40px; border-radius: 20px; width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 6px solid var(--gold); border-bottom: 6px solid var(--primary);
        }
        .login-title { font-family: 'Amiri'; color: var(--primary); font-size: 2rem; margin-bottom: 25px; font-weight: bold; }
        .login-label { display: block; text-align: right; margin-bottom: 8px; font-weight: bold; color: var(--dark); }
        
        select, input { 
            width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #ddd; 
            font-family: 'Cairo'; font-size: 1rem; outline: none; text-align: center; 
            box-sizing: border-box; margin-bottom: 20px; background: #fff; transition: 0.3s;
        }
        select:focus, input:focus { border-color: var(--gold); box-shadow: 0 0 8px rgba(212, 172, 13, 0.2); }
        
        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        button { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.2s; font-size: 1rem; width: 100%; }
        .btn-main { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(20, 90, 50, 0.2); }
        .btn-main:hover { background: #0e4023; transform: translateY(-2px); }
        .btn-sec { background: var(--gold); color: black; box-shadow: 0 4px 10px rgba(212, 172, 13, 0.2); }
        .btn-danger { background: #c0392b; color: white; }
        .btn-bulk { background: #34495e; color: white; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ --- */
        .screen-content { width: 100%; max-width: 900px; display: none; animation: fadeIn 0.5s; }
        header { 
            background: white; padding: 25px; border-radius: 20px; text-align: center; 
            border: 1px solid #eee; border-top: 6px solid var(--gold); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: relative; margin-bottom: 25px; 
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; position: absolute; top: 15px; left: 15px; right: 15px; }
        
        h1 { font-family: 'Amiri'; color: var(--primary); margin: 25px 0 5px; font-size: 1.8rem; }
        .sheikh-name { color: #d35400; font-weight: bold; font-size: 1.2rem; font-family: 'Amiri'; }
        
        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; } 
        .student-card { 
            background: white; border-radius: 15px; padding: 15px; position: relative; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; border-top: 4px solid #ccc;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; align-items: center; 
        }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        
        .icon-wrapper { 
            width: 55px; height: 55px; background: #fafafa; border-radius: 50%; margin: 5px auto 10px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border: 2px solid #eee; color: #ccc; 
        }
        .student-name { font-weight: bold; font-size: 1.2rem; color: #444; text-align: center; margin-bottom: 8px; font-family: 'Amiri'; }
        
        .student-card.present { border-color: var(--primary); background: linear-gradient(to bottom, #ffffff, #f4fcf7); border-top-color: var(--gold); }
        .student-card.present .icon-wrapper { background: white; border-color: var(--gold); color: var(--primary); box-shadow: 0 0 10px rgba(212, 172, 13, 0.3); }
        .student-card.present .student-name { color: var(--primary); }
        
        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
        .student-tools { display: none; width: 100%; flex-direction: column; gap: 6px; margin-top: 5px; animation: fadeIn 0.3s; }
        .student-card.present .student-tools { display: flex; }
        .tool-row { display: flex; gap: 5px; width: 100%; }
        .mini-select { flex-grow: 1; padding: 5px; border: 1px solid var(--gold); border-radius: 8px; font-family: 'Cairo'; font-size: 0.85rem; outline: none; text-align: center; background: white; margin: 0; }
        .btn-step { width: 30px; height: 30px; border-radius: 8px; border: none; background: #eee; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-step:hover { background: var(--gold); color: white; }
        .btn-del { position: absolute; top: 8px; left: 8px; width: 22px; height: 22px; background: #fff; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; opacity: 0.5; transition: 0.2s; }
        .btn-del:hover { opacity: 1; background: #e74c3c; color: white; }

        /* --- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) --- */
        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background-color: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3); border: 2px solid var(--gold); }
        textarea { width: 100%; height: 150px; margin: 15px 0; padding: 12px; border-radius: 12px; border: 2px solid #eee; font-family: 'Cairo'; resize: none; outline: none; box-sizing: border-box; }

        /* --- Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠ --- */
        .controls { position: fixed; bottom: 0; background: white; width: 100%; padding: 15px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); display: none; flex-direction: column; gap: 10px; align-items: center; z-index: 100; border-top: 4px solid var(--gold); }
        .row { display: flex; gap: 10px; width: 100%; justify-content: center; }
        
        /* --- Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (A4 Report) --- */
        #printable-area { display: none; }
        @media print {
            .screen-content, #login-screen, .controls, #loading-overlay, .modal { display: none !important; }
            body { background: white; margin: 0; padding: 0; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #printable-area { display: block; width: 100%; padding: 10mm; box-sizing: border-box; }
            
            thead { display: table-header-group; } 
            tr { page-break-inside: avoid; } 
            .footer-signature, .stats-grid, .report-info { page-break-inside: avoid; }

            .official-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
            .official-header h3 { margin: 2px 0; font-weight: normal; font-size: 11pt; color: #444; }
            .official-header h2 { margin: 8px 0; font-size: 18pt; font-weight: bold; color: #000; }
            
            .center-wrapper { text-align: center; margin-bottom: 15px; }
            .report-title { font-size: 20pt; font-weight: bold; display: inline-block; padding: 5px 30px; border: 2px solid #333; border-radius: 8px; background: #fdfdfd; }
            
            .report-info { display: flex; justify-content: space-between; border: 1px solid #777; border-radius: 5px; padding: 10px; margin-bottom: 15px; background: #fcfcfc; }
            .right-info { text-align: right; width: 50%; border-left: 1px dashed #ccc; }
            .left-info { text-align: left; width: 50%; direction: ltr; } .left-info div { direction: rtl; }
            
            .stats-grid { display: flex; border: 1px solid #777; border-radius: 5px; background: #f9f9f9; margin-bottom: 20px; }
            .stat-item { flex: 1; text-align: center; padding: 8px; border-left: 1px dashed #ccc; } .stat-item:last-child { border-left: none; }
            .stat-title { display: block; font-size: 10pt; color: #555; font-weight: bold; } .stat-count { font-size: 14pt; font-weight: bold; }

            table { width: 100%; border-collapse: collapse; font-size: 12pt; text-align: center; margin-bottom: 30px; }
            th { background-color: #eee !important; border: 1px solid #444; padding: 8px; font-weight: bold; }
            td { border: 1px solid #444; padding: 6px; height: 35px; vertical-align: middle; }
            tr:nth-child(even) { background-color: #fcfcfc; }
            
            .footer-signature { display: flex; justify-content: space-between; padding: 0 50px; font-size: 14pt; font-weight: bold; margin-top: 40px; }
        }
        
        #save-status { font-size: 0.9rem; font-weight: bold; color: #27ae60; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <div id="loading-text" style="font-weight:bold; margin-top:10px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</div>
            
            <div id="step-1">
                <label class="login-label">ğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / Ø§Ù„Ù…Ø³Ø¬Ø¯:</label>
                <select id="mosqueSelect" onchange="loadMosqueData()">
                    <option value="" disabled selected>-- Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ù„ÙŠÙ„... --</option>
                </select>
            </div>

            <div id="step-2" style="display:none; margin-top:20px; border-top:1px dashed #ccc; padding-top:20px; animation: fadeIn 0.5s;">
                <label class="login-label">ğŸ“– Ø§Ø®ØªØ± Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…:</label>
                <select id="halaqaSelect" onchange="document.getElementById('pinInput').value=''"></select>
                <input type="password" id="pinInput" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)" maxlength="4">
                <button class="btn-main" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                <div style="margin-top:15px;">
                    <button style="background:transparent; color:#555; border:1px solid #ccc; width:auto; font-size:0.9rem;" onclick="createHalaqa()">+ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <div class="screen-content" id="app-content">
        <header>
            <div class="header-top">
                <div id="save-status">âœ…</div>
                <button style="background:#e74c3c; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-weight:bold;" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <h1 id="app-mosque-title">...</h1>
            <div class="sheikh-name">Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…: <span id="display-sheikh">--</span></div>
            <div style="margin-top:10px; font-weight:bold; color:var(--primary);">
                Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…: <span id="count">0</span>
            </div>
        </header>

        <input type="text" style="width:100%; padding:14px; border-radius:12px; border:2px solid #eee; font-family:'Cairo'; text-align:center; outline:none;" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." onkeyup="render(this.value)">
        
        <div class="grid-container" id="grid"></div>
    </div>

    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨</h3>
            <p style="font-size:0.9rem; color:#666;">Ù‚Ù… Ø¨Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§ (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±):</p>
            <textarea id="bulkText" placeholder="Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ&#10;ÙŠØ§Ø³ÙŠÙ† Ø£Ø­Ù…Ø¯&#10;Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†..."></textarea>
            <div class="row">
                <button class="btn-main" style="flex:1;" onclick="saveBulkData()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <button class="btn-danger" style="flex:1;" onclick="closeBulkModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="controls" id="app-controls">
        <button class="btn-sec" onclick="printPDF()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF)</button>
        <div class="row" style="width:100%">
            <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø·Ø§Ù„Ø¨..." style="margin:0; flex-grow:1;">
            <button class="btn-main" style="width:auto;" onclick="addStudent()">â•</button>
            <button class="btn-bulk" style="width:auto;" onclick="openBulkModal()">ğŸ“ Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
        <button class="btn-danger" onclick="resetDay()">ğŸ—‘ï¸ ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯)</button>
    </div>

    <div id="printable-area">
        <div class="official-header">
            <h3>Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©</h3>
            <h3>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Ù</h3>
            <h3>Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Ù Ù„ÙˆÙ„Ø§ÙŠØ© <span id="print-wilaya"></span></h3>
            <h2 id="print-mosque-title"></h2>
        </div>
        
        <div class="center-wrapper">
            <div class="report-title">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</div>
        </div>

        <div class="report-info">
            <div class="right-info">
                <div><strong>Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> <span id="print-report-no"></span></div>
                <div><strong>Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> <span id="print-sheikh"></span></div>
            </div>
            <div class="left-info">
                <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="print-date"></span></div>
                <div><strong>Ø§Ù„Ø¥Ø­ØµØ§Ø¡:</strong> <span id="print-stats"></span></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-item"><span class="stat-title">Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ</span><span class="stat-count" id="c-prim">0</span></div>
            <div class="stat-item"><span class="stat-title">Ù…ØªÙˆØ³Ø·</span><span class="stat-count" id="c-mid">0</span></div>
            <div class="stat-item"><span class="stat-title">Ø«Ø§Ù†ÙˆÙŠ</span><span class="stat-count" id="c-sec">0</span></div>
            <div class="stat-item"><span class="stat-title">Ø¬Ø§Ù…Ø¹ÙŠ</span><span class="stat-count" id="c-univ">0</span></div>
        </div>

        <table id="print-table">
            <thead>
                <tr>
                    <th width="5%">Ø±Ù‚Ù…</th>
                    <th width="35%">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th width="15%">Ø§Ù„Ø·ÙˆØ±</th>
                    <th width="10%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th width="20%">Ø§Ù„Ù…Ø­ÙÙˆØ¸</th>
                    <th width="15%">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                </tr>
            </thead>
            <tbody id="print-body"></tbody>
        </table>
        
        <div class="footer-signature">
            <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</div>
            <div>Ø®ØªÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ø¥Ù…Ø§Ù…</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”— Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Master Sheet)
        // ==========================================
        // ğŸ”´ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Direct Link) Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯
        const MASTER_DIR_URL = "https://script.google.com/macros/s/AKfycbzH8e9GMVMMSiff6-Ccp4jCH_zLlhi9JEaPHZKOuRaYP9jXOdThd69ZhJqWZBf1n-u5Ng/exec"; 
        // ==========================================

        // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø«Ø§Ø¨ØªØ©
        const levelsList = [
            "1 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "2 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "3 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "4 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ",
            "1 Ù…ØªÙˆØ³Ø·", "2 Ù…ØªÙˆØ³Ø·", "3 Ù…ØªÙˆØ³Ø·", "4 Ù…ØªÙˆØ³Ø·",
            "1 Ø«Ø§Ù†ÙˆÙŠ", "2 Ø«Ø§Ù†ÙˆÙŠ", "3 Ø«Ø§Ù†ÙˆÙŠ", "Ø¬Ø§Ù…Ø¹ÙŠ"
        ];
        const surahList = ["Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"];

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        let mosquesList = [];
        let currentMosqueData = null;
        let appData = { halaqat: [] };
        let selectedHalaqaIdx = -1;
        let saveTimer;

        // --- 1. Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ù„ÙŠÙ„ ---
        window.onload = async function() {
            if(MASTER_DIR_URL.includes("PUT_YOUR")) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· 'Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ' ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…!");
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }

            try {
                const res = await fetch(MASTER_DIR_URL);
                mosquesList = await res.json();
                
                const select = document.getElementById('mosqueSelect');
                select.innerHTML = '<option value="" disabled selected>-- Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± --</option>';
                
                mosquesList.forEach((m, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = m.name;
                    select.appendChild(opt);
                });
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                document.getElementById('loading-text').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
            }
        };

        // --- 2. ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ø¯ ---
        async function loadMosqueData() {
            const idx = document.getElementById('mosqueSelect').value;
            currentMosqueData = mosquesList[idx];
            
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ' + currentMosqueData.name;
            
            try {
                const res = await fetch(currentMosqueData.url);
                const data = await res.json();
                appData = data.halaqat ? data : { halaqat: [] };
                
                const hSelect = document.getElementById('halaqaSelect');
                hSelect.innerHTML = '';
                if(appData.halaqat.length === 0) {
                    hSelect.innerHTML = '<option>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§ØªØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø©</option>';
                } else {
                    appData.halaqat.forEach((h, i) => {
                        hSelect.innerHTML += `<option value="${i}">${h.sheikh}</option>`;
                    });
                }
                document.getElementById('step-2').style.display = 'block';
            } catch(e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø¬Ø¯! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡.");
            }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- 3. Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø§Øª ---
        function attemptLogin() {
            if(appData.halaqat.length === 0) return;
            const idx = document.getElementById('halaqaSelect').value;
            const pin = document.getElementById('pinInput').value;
            
            if(appData.halaqat[idx].pin == pin) {
                selectedHalaqaIdx = idx;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('app-controls').style.display = 'flex';
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                document.getElementById('app-mosque-title').innerText = currentMosqueData.name;
                document.getElementById('display-sheikh').innerText = appData.halaqat[idx].sheikh;
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                document.getElementById('print-mosque-title').innerText = currentMosqueData.name;
                document.getElementById('print-wilaya').innerText = currentMosqueData.wilaya;
                document.getElementById('print-sheikh').innerText = appData.halaqat[idx].sheikh;
                
                render();
            } else {
                alert("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­!");
            }
        }

        function createHalaqa() {
            const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…:");
            const pin = prompt("Ø£Ù†Ø´Ø¦ Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ (PIN):");
            if(name && pin) {
                appData.halaqat.push({ sheikh: name, pin: pin, students: [] });
                saveData();
                alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø©! Ø§Ø®ØªØ±Ù‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
            }
        }

        // --- 4. Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ---
        function queueSave() {
            document.getElementById('save-status').innerText = "â³";
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveData, 2000); // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        }

        async function saveData() {
            if(!currentMosqueData) return;
            document.getElementById('save-status').innerText = "ğŸ”„";
            document.getElementById('save-status').style.color = "#3498db";
            
            try {
                await fetch(currentMosqueData.url, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(appData)
                });
                document.getElementById('save-status').innerText = "âœ…";
                document.getElementById('save-status').style.color = "#27ae60";
            } catch(e) {
                document.getElementById('save-status').innerText = "âŒ";
                document.getElementById('save-status').style.color = "#c0392b";
            }
        }

        // --- 5. Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­ÙƒÙ… (Render Logic) ---
        function render(filter="") {
            const list = document.getElementById('grid');
            list.innerHTML = '';
            const h = appData.halaqat[selectedHalaqaIdx];
            let pCount = 0;
            
            // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø­Ø§Ø¶Ø± Ø£ÙˆÙ„Ø§Ù‹ (Ø£Ø¨Ø¬Ø¯ÙŠ)ØŒ Ø«Ù… Ø§Ù„ØºØ§Ø¦Ø¨ (Ø£Ø¨Ø¬Ø¯ÙŠ)
            h.students.sort((a,b) => {
                if (a.present !== b.present) return a.present ? -1 : 1;
                return a.name.localeCompare(b.name, 'ar');
            });

            // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            const levelsOpt = levelsList.map(l => `<option value="${l}">${l}</option>`).join('');
            const surahOpt = surahList.map((s, i) => `<option value="${i}">${s}</option>`).join('');

            h.students.forEach((s, idx) => {
                if(filter && !s.name.includes(filter)) return;
                if(s.present) pCount++;
                
                const div = document.createElement('div');
                div.className = `student-card ${s.present?'present':''}`;
                
                div.innerHTML = `
                    <button class="btn-del" onclick="deleteStudent(${idx}, event)">Ã—</button>
                    <div class="icon-wrapper">${s.present ? 'ğŸ•Œ' : 'ğŸ‘¤'}</div>
                    <div class="student-name">${s.name}</div>
                    
                    <div class="student-tools" onclick="event.stopPropagation()">
                        <div class="tool-row">
                            <select class="mini-select level-sel" onchange="updateLevel(${idx}, this.value)">${levelsOpt}</select>
                        </div>
                        <div class="tool-row">
                            <button class="btn-step" onclick="stepSurah(${idx}, -1)">â¬…ï¸</button>
                            <select class="mini-select surah-sel" onchange="updateSurah(${idx}, this.value)">${surahOpt}</select>
                            <button class="btn-step" onclick="stepSurah(${idx}, 1)">â¡ï¸</button>
                        </div>
                    </div>
                `;
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                if(s.present) {
                    setTimeout(() => {
                        div.querySelector('.level-sel').value = s.level || levelsList[0];
                        div.querySelector('.surah-sel').value = s.surahIndex || 113; // Ø§Ù„ÙÙ„Ù‚ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                    }, 0);
                }

                // Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
                div.onclick = (e) => { 
                    if(!e.target.closest('.student-tools') && !e.target.classList.contains('btn-del')) {
                        s.present = !s.present; 
                        render(filter); queueSave(); 
                    }
                };
                
                list.appendChild(div);
            });
            document.getElementById('count').innerText = `${pCount} / ${h.students.length}`;
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---
        function addStudent() {
            const n = document.getElementById('newStudentName').value.trim();
            if(n) {
                appData.halaqat[selectedHalaqaIdx].students.push({name: n, present: false, level: levelsList[0], surahIndex: 113});
                document.getElementById('newStudentName').value = '';
                render(); queueSave();
            }
        }
        function deleteStudent(idx, e) {
            e.stopPropagation();
            if(confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                appData.halaqat[selectedHalaqaIdx].students.splice(idx, 1);
                render(); queueSave();
            }
        }
        function updateLevel(idx, val) { appData.halaqat[selectedHalaqaIdx].students[idx].level = val; queueSave(); }
        function updateSurah(idx, val) { appData.halaqat[selectedHalaqaIdx].students[idx].surahIndex = parseInt(val); queueSave(); }
        function stepSurah(idx, dir) {
            let s = appData.halaqat[selectedHalaqaIdx].students[idx];
            let next = (s.surahIndex || 113) + dir;
            if(next >= 0 && next < surahList.length) { s.surahIndex = next; render(); queueSave(); }
        }
        function resetDay() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ØŸ")) {
                appData.halaqat[selectedHalaqaIdx].students.forEach(s => s.present = false);
                render(); queueSave();
            }
        }
        function logout() { location.reload(); }

        // --- Ù…ÙŠØ²Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Bulk) ---
        function openBulkModal() { document.getElementById('bulkModal').style.display = 'flex'; }
        function closeBulkModal() { document.getElementById('bulkModal').style.display = 'none'; }
        
        function saveBulkData() {
            const text = document.getElementById('bulkText').value;
            const names = text.split('\n');
            let addedCount = 0;
            
            names.forEach(n => {
                n = n.trim();
                if(n) {
                    appData.halaqat[selectedHalaqaIdx].students.push({
                        name: n, 
                        present: false, 
                        level: levelsList[0], 
                        surahIndex: 113
                    });
                    addedCount++;
                }
            });
            
            if(addedCount > 0) {
                document.getElementById('bulkText').value = '';
                closeBulkModal();
                render();
                saveData();
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© " + addedCount + " Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø£Ø³Ù…Ø§Ø¡!");
            }
        }

        // --- 6. Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
        function printPDF() {
            const h = appData.halaqat[selectedHalaqaIdx];
            const now = new Date();
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
            document.getElementById('print-report-no').innerText = `REP-${now.getFullYear()}${now.getMonth()+1}${now.getDate()}-${now.getHours()}`;
            document.getElementById('print-date').innerText = now.toLocaleDateString('ar-DZ');
            document.getElementById('print-stats').innerText = `Ø­Ø¶ÙˆØ±: ${h.students.filter(s=>s.present).length} | ØºÙŠØ§Ø¨: ${h.students.filter(s=>!s.present).length} | ÙƒÙ„ÙŠ: ${h.students.length}`;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø·ÙˆØ§Ø±
            let cPrim=0, cMid=0, cSec=0, cUniv=0;
            h.students.forEach(s => {
                let l = s.level || "";
                if(l.includes("Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ")) cPrim++;
                else if(l.includes("Ù…ØªÙˆØ³Ø·")) cMid++;
                else if(l.includes("Ø«Ø§Ù†ÙˆÙŠ")) cSec++;
                else if(l.includes("Ø¬Ø§Ù…Ø¹ÙŠ")) cUniv++;
            });
            document.getElementById('c-prim').innerText = cPrim;
            document.getElementById('c-mid').innerText = cMid;
            document.getElementById('c-sec').innerText = cSec;
            document.getElementById('c-univ').innerText = cUniv;

            // Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const tbody = document.getElementById('print-body');
            tbody.innerHTML = '';
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶)
            const sorted = [...h.students].sort((a,b) => (a.present !== b.present) ? (a.present?-1:1) : a.name.localeCompare(b.name,'ar'));
            
            let i = 1;
            sorted.forEach(s => {
                const stText = s.present ? 'Ø­Ø§Ø¶Ø±' : 'ØºÙŠØ§Ø¨';
                const stColor = s.present ? '#27ae60' : '#c0392b';
                const surah = surahList[s.surahIndex||113];
                tbody.innerHTML += `
                    <tr>
                        <td>${i++}</td>
                        <td style="text-align:right; font-weight:bold; padding-right:8px;">${s.name}</td>
                        <td>${s.level || '-'}</td>
                        <td style="color:${stColor}; font-weight:bold;">${stText}</td>
                        <td>${surah}</td>
                        <td></td>
                    </tr>
                `;
            });
            window.print();
        }
    </script>
</body>
</html>