<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #145A32; --gold: #D4AC0D; --bg: #F9F9F3; --btn-bg: #ecf0f1; --dark: #2c3e50; --blue: #2980b9; --red: #c0392b; }
        
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--bg); margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center; padding-bottom: 180px;
            min-height: 100vh;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%;
            width: 50px; height: 50px; animation: spin 0.8s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø£Ø³ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) --- */
        header { 
            background: white; padding: 15px; border-radius: 15px; text-align: center; 
            border: 1px solid #eee; border-top: 6px solid var(--gold); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); width: 100%; max-width: 900px;
            position: relative; margin-bottom: 20px; box-sizing: border-box;
        }

        .header-actions {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;
        }

        .btn-header {
            border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
            font-family: 'Cairo'; font-weight: bold; font-size: 0.85rem; color: white;
            display: inline-flex; align-items: center; gap: 5px; text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-header:active { transform: translateY(1px); }

        .btn-sync { background: var(--gold); color: #000; }
        .btn-pin { background: var(--dark); }
        .btn-logout { background: var(--red); margin-right: 5px; }

        .mosque-title { font-family: 'Amiri'; color: var(--primary); font-size: 1.8rem; margin: 5px 0; font-weight: bold; line-height: 1.2; }
        .sheikh-info { color: #d35400; font-weight: bold; font-size: 1.3rem; font-family: 'Amiri'; margin-bottom: 5px; }
        .attendance-info { font-weight: bold; color: var(--primary); font-size: 1rem; }
        
        .save-indicator {
            font-size: 0.8rem; font-weight: bold; color: #27ae60; margin-top: 5px; display: inline-block;
        }

        .btn-delete-halaqa {
            position: absolute; bottom: 10px; left: 15px;
            background: none; border: none; color: var(--red); 
            font-size: 0.8rem; cursor: pointer; text-decoration: underline;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-screen { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; text-align: center; }
        .login-box {
            background: white; padding: 40px; border-radius: 20px; width: 100%; box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 6px solid var(--gold); border-bottom: 6px solid var(--primary);
        }
        .login-title { font-family: 'Amiri'; color: var(--primary); font-size: 2rem; margin-bottom: 25px; font-weight: bold; }
        
        select, input { 
            width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ddd; 
            font-family: 'Cairo'; font-size: 1rem; outline: none; text-align: center; 
            box-sizing: border-box; margin-bottom: 15px; background: #fff; transition: 0.3s;
        }
        select:focus, input:focus { border-color: var(--gold); }
        
        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© --- */
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-sec { background: var(--gold); color: black; border:none; padding:10px; border-radius:10px; font-weight:bold; cursor:pointer; width:100%; }
        
        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .screen-content { width: 100%; max-width: 900px; display: none; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 12px; margin-top:15px; } 
        
        .student-card { 
            background: white; border-radius: 12px; padding: 12px; position: relative; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; border-top: 4px solid #ccc;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center; 
        }
        .student-card.present { border-color: var(--primary); background: linear-gradient(to bottom, #ffffff, #f4fcf7); border-top-color: var(--gold); }
        
        .icon-wrapper { 
            width: 50px; height: 50px; background: #fafafa; border-radius: 50%; margin-bottom: 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.6rem; border: 2px solid #eee; color: #ccc; 
        }
        .student-card.present .icon-wrapper { background: white; border-color: var(--gold); color: var(--primary); }
        .student-name { font-weight: bold; font-size: 1.1rem; color: #444; text-align: center; font-family: 'Amiri'; margin-bottom: 5px; }
        .student-card.present .student-name { color: var(--primary); }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
        .student-tools { display: none; width: 100%; flex-direction: column; gap: 5px; margin-top: 5px; }
        .student-card.present .student-tools { display: flex; }
        .tool-row { display: flex; gap: 4px; width: 100%; }
        .mini-select { flex-grow: 1; padding: 4px; border: 1px solid var(--gold); border-radius: 6px; font-family: 'Cairo'; font-size: 0.8rem; outline: none; text-align: center; background: white; }
        .btn-step { width: 28px; height: 28px; border-radius: 6px; border: none; background: #eee; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-step:hover { background: var(--gold); color: white; }
        .btn-del { position: absolute; top: 5px; left: 5px; width: 20px; height: 20px; background: #fff; color: var(--red); border: 1px solid var(--red); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; opacity: 0.6; }

        /* --- Ø§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„ØªØ­ÙƒÙ… --- */
        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 2px solid var(--gold); }
        textarea { width: 100%; height: 150px; margin: 15px 0; padding: 10px; border-radius: 10px; border: 2px solid #eee; font-family: 'Cairo'; resize: none; box-sizing: border-box; }

        .controls { position: fixed; bottom: 0; background: white; width: 100%; padding: 12px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: none; flex-direction: column; gap: 8px; z-index: 100; border-top: 4px solid var(--gold); }
        .row { display: flex; gap: 8px; width: 100%; justify-content: center; }
        .btn-bulk { background: #34495e; color: white; width: auto; padding: 12px 15px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; }

        /* --- Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
        #printable-area { display: none; }
        @media print {
            .screen-content, #login-screen, .controls, #loading-overlay, .modal { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            #printable-area { display: block; width: 100%; padding: 10mm; box-sizing: border-box; }
            table { width: 100%; border-collapse: collapse; font-size: 12pt; text-align: center; margin-bottom: 20px; }
            th, td { border: 1px solid #000; padding: 5px; } th { background: #eee !important; }
            .official-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
            .stats-grid { display: flex; border: 1px solid #777; margin-bottom: 20px; }
            .stat-item { flex: 1; text-align: center; border-left: 1px solid #ccc; padding: 5px; } .stat-item:last-child { border-left: none; }
            .footer-signature { display: flex; justify-content: space-between; margin-top: 40px; font-weight: bold; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <div id="loading-text" style="font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</div>
            
            <div id="step-1">
                <label style="display:block; text-align:right; font-weight:bold; margin-bottom:5px;">ğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / Ø§Ù„Ù…Ø³Ø¬Ø¯:</label>
                <select id="mosqueSelect" onchange="loadMosqueData()">
                    <option value="" disabled selected>-- Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„... --</option>
                </select>
            </div>

            <div id="step-2" style="display:none; animation: fadeIn 0.5s;">
                <label style="display:block; text-align:right; font-weight:bold; margin-bottom:5px;">ğŸ“– Ø§Ø®ØªØ± Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…:</label>
                <select id="halaqaSelect" onchange="document.getElementById('pinInput').value=''"></select>
                <input type="password" id="pinInput" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)" maxlength="4">
                <button class="btn-main" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                <div style="margin-top:15px;">
                    <button style="background:transparent; color:#555; border:1px solid #ccc; width:auto; font-size:0.9rem;" onclick="createHalaqa()">+ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <div class="screen-content" id="app-content">
        <header>
            <div class="header-actions">
                <div>
                    <button class="btn-header btn-sync" onclick="forceSync()">Ù…Ø²Ø§Ù…Ù†Ø© ğŸ”„</button>
                </div>
                <div>
                    <button class="btn-header btn-pin" onclick="changeCurrentPin()">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø² ğŸ”‘</button>
                    <button class="btn-header btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸ”’</button>
                </div>
            </div>

            <div class="save-indicator">
                <span id="save-status">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© âœ…</span>
            </div>

            <h1 class="mosque-title" id="app-mosque-title">Ù…Ø³Ø¬Ø¯ Ø§Ù„ØªÙ‚ÙˆÙ‰</h1>
            <div class="sheikh-info">Ø­Ù„Ù‚Ø©: <span id="display-sheikh">--</span></div>
            <div class="attendance-info">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…: <span id="count">0 / 0</span></div>

            <button class="btn-delete-halaqa" onclick="deleteCurrentHalaqa()">Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø©</button>
        </header>

        <input type="text" style="width:100%; padding:14px; border-radius:12px; border:2px solid #eee; font-family:'Cairo'; text-align:center; outline:none;" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." onkeyup="render(this.value)">
        
        <div class="grid-container" id="grid"></div>
    </div>

    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨</h3>
            <textarea id="bulkText" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„&#10;Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ..."></textarea>
            <div class="row">
                <button class="btn-main" onclick="saveBulkData()">Ø­ÙØ¸</button>
                <button class="btn-danger" onclick="closeBulkModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="controls" id="app-controls">
        <button class="btn-sec" onclick="printPDF()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF)</button>
        <div class="row" style="width:100%">
            <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø·Ø§Ù„Ø¨..." style="margin:0; flex-grow:1;">
            <button class="btn-main" style="width:auto;" onclick="addStudent()">â•</button>
            <button class="btn-bulk" onclick="openBulkModal()">ğŸ“</button>
        </div>
        <button class="btn-danger" style="background:#c0392b; color:white; border:none; padding:10px; border-radius:10px; cursor:pointer;" onclick="resetDay()">ğŸ—‘ï¸ ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
    </div>

    <div id="printable-area">
        <div class="official-header">
            <h3>Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©</h3>
            <h3>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Ù</h3>
            <h3>Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Ù Ù„ÙˆÙ„Ø§ÙŠØ© <span id="print-wilaya"></span></h3>
            <h2 id="print-mosque-title"></h2>
        </div>
        <div class="center-wrapper">
            <div class="report-title" style="font-size:18pt; font-weight:bold; border:2px solid black; padding:5px 20px; border-radius:8px; display:inline-block; margin-bottom:15px;">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</div>
        </div>
        <div class="report-info">
            <div class="right-info">
                <div><strong>Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> <span id="print-report-no"></span></div>
                <div><strong>Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> <span id="print-sheikh"></span></div>
            </div>
            <div class="left-info">
                <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="print-date"></span></div>
                <div><strong>Ø§Ù„Ø¥Ø­ØµØ§Ø¡:</strong> <span id="print-stats"></span></div>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-item"><strong>Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ:</strong> <span id="c-prim">0</span></div>
            <div class="stat-item"><strong>Ù…ØªÙˆØ³Ø·:</strong> <span id="c-mid">0</span></div>
            <div class="stat-item"><strong>Ø«Ø§Ù†ÙˆÙŠ:</strong> <span id="c-sec">0</span></div>
            <div class="stat-item"><strong>Ø¬Ø§Ù…Ø¹ÙŠ:</strong> <span id="c-univ">0</span></div>
        </div>
        <table id="print-table">
            <thead><tr><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø·ÙˆØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø­ÙÙˆØ¸</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
            <tbody id="print-body"></tbody>
        </table>
        <div class="footer-signature"><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</div><div>Ø®ØªÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div></div>
    </div>

    <script>
        // ==========================================
        // ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
        // ==========================================
        const MASTER_DIR_URL = "https://script.google.com/macros/s/AKfycbzsTqXLWLB8iY4h6YnVkdcbfZW8feKwx6HJrbNEzJA7GL-jMLjnEiqW64T-aftK6o-aOQ/exec"; 
        // ==========================================

        const levelsList = ["1 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "2 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "3 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "4 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5 Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ", "1 Ù…ØªÙˆØ³Ø·", "2 Ù…ØªÙˆØ³Ø·", "3 Ù…ØªÙˆØ³Ø·", "4 Ù…ØªÙˆØ³Ø·", "1 Ø«Ø§Ù†ÙˆÙŠ", "2 Ø«Ø§Ù†ÙˆÙŠ", "3 Ø«Ø§Ù†ÙˆÙŠ", "Ø¬Ø§Ù…Ø¹ÙŠ"];
        const surahList = ["Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"];

        let mosquesList = [];
        let currentMosqueData = null;
        let appData = { halaqat: [] };
        let selectedHalaqaIdx = -1;
        let saveTimer;

        // --- 1. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (Ù…Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª) ---
        window.onload = async function() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø³Ø®Ø© Ù…Ø®Ø²Ù†Ø© Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„ÙØªØ­
            const cachedMosques = localStorage.getItem('cachedMosques');
            if (cachedMosques) {
                mosquesList = JSON.parse(cachedMosques);
                fillMosqueSelect();
                document.getElementById('loading-overlay').style.display = 'none';
            }

            // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            if(MASTER_DIR_URL.includes("PUT_YOUR")) {
                alert("ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ!"); return;
            }

            try {
                const res = await fetch(MASTER_DIR_URL);
                mosquesList = await res.json();
                localStorage.setItem('cachedMosques', JSON.stringify(mosquesList)); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
                fillMosqueSelect();
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) {
                if (!cachedMosques) alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!");
            }
        };

        function fillMosqueSelect() {
            const select = document.getElementById('mosqueSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="" disabled selected>-- Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± --</option>';
            mosquesList.forEach((m, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = m.name;
                select.appendChild(opt);
            });
            if(currentVal) select.value = currentVal;
        }

        // --- 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ø¯ ---
        async function loadMosqueData() {
            const idx = document.getElementById('mosqueSelect').value;
            currentMosqueData = mosquesList[idx];
            document.getElementById('loading-overlay').style.display = 'flex';
            
            try {
                const res = await fetch(currentMosqueData.url);
                const data = await res.json();
                appData = data.halaqat ? data : { halaqat: [] };
                
                const hSelect = document.getElementById('halaqaSelect');
                hSelect.innerHTML = '';
                if(appData.halaqat.length === 0) hSelect.innerHTML = '<option>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª</option>';
                else appData.halaqat.forEach((h, i) => hSelect.innerHTML += `<option value="${i}">${h.sheikh}</option>`);
                
                document.getElementById('step-2').style.display = 'block';
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ø¯!"); }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- 3. Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        function attemptLogin() {
            if(appData.halaqat.length === 0) return;
            const idx = document.getElementById('halaqaSelect').value;
            const pin = document.getElementById('pinInput').value;
            
            if(appData.halaqat[idx].pin == pin) {
                selectedHalaqaIdx = idx;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('app-controls').style.display = 'flex';
                
                document.getElementById('app-mosque-title').innerText = currentMosqueData.name;
                document.getElementById('display-sheikh').innerText = appData.halaqat[idx].sheikh;
                document.getElementById('print-mosque-title').innerText = currentMosqueData.name;
                document.getElementById('print-wilaya').innerText = currentMosqueData.wilaya;
                document.getElementById('print-sheikh').innerText = appData.halaqat[idx].sheikh;
                
                render();
            } else { alert("Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£!"); }
        }

        function createHalaqa() {
            const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…:");
            const pin = prompt("Ø±Ù…Ø² PIN:");
            if(name && pin) {
                appData.halaqat.push({ sheikh: name, pin: pin, students: [] });
                saveData(); alert("ØªÙ…! Ø§Ø®ØªØ± Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø¢Ù†."); location.reload();
            }
        }

        // --- 4. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø±ÙŠØ¹ ---
        function queueSave() {
            const status = document.getElementById('save-status');
            status.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            status.style.color = "#e67e22";
            clearTimeout(saveTimer);
            saveTimer = setTimeout(saveData, 1000); // Ø­ÙØ¸ Ø¨Ø¹Ø¯ 1 Ø«Ø§Ù†ÙŠØ© ÙÙ‚Ø·
        }

        async function saveData() {
            if(!currentMosqueData) return;
            try {
                await fetch(currentMosqueData.url, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(appData)
                });
                document.getElementById('save-status').innerText = "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© âœ…";
                document.getElementById('save-status').style.color = "#27ae60";
            } catch(e) {
                document.getElementById('save-status').innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸";
                document.getElementById('save-status').style.color = "#c0392b";
            }
        }

        function forceSync() {
            if(confirm("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±ØŸ")) {
                document.getElementById('loading-overlay').style.display = 'flex';
                loadMosqueData().then(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    render();
                });
            }
        }

        // --- 5. Ø§Ù„Ø¹Ø±Ø¶ ---
        function render(filter="") {
            const list = document.getElementById('grid');
            list.innerHTML = '';
            const h = appData.halaqat[selectedHalaqaIdx];
            let pCount = 0;
            
            h.students.sort((a,b) => (a.present !== b.present) ? (a.present ? -1 : 1) : a.name.localeCompare(b.name, 'ar'));

            const levelsOpt = levelsList.map(l => `<option value="${l}">${l}</option>`).join('');
            const surahOpt = surahList.map((s, i) => `<option value="${i}">${s}</option>`).join('');

            h.students.forEach((s, idx) => {
                if(filter && !s.name.includes(filter)) return;
                if(s.present) pCount++;
                
                const div = document.createElement('div');
                div.className = `student-card ${s.present?'present':''}`;
                
                div.innerHTML = `
                    <button class="btn-del" onclick="deleteStudent(${idx}, event)">Ã—</button>
                    <div class="icon-wrapper">${s.present ? 'ğŸ•Œ' : 'ğŸ‘¤'}</div>
                    <div class="student-name">${s.name}</div>
                    <div class="student-tools" onclick="event.stopPropagation()">
                        <div class="tool-row"><select class="mini-select level-sel" onchange="updateLevel(${idx}, this.value)">${levelsOpt}</select></div>
                        <div class="tool-row">
                            <button class="btn-step" onclick="stepSurah(${idx}, -1)">â¬…ï¸</button>
                            <select class="mini-select surah-sel" onchange="updateSurah(${idx}, this.value)">${surahOpt}</select>
                            <button class="btn-step" onclick="stepSurah(${idx}, 1)">â¡ï¸</button>
                        </div>
                    </div>`;
                
                if(s.present) {
                    setTimeout(() => {
                        div.querySelector('.level-sel').value = s.level || levelsList[0];
                        div.querySelector('.surah-sel').value = s.surahIndex || 113;
                    }, 0);
                }
                div.onclick = (e) => { 
                    if(!e.target.closest('.student-tools') && !e.target.classList.contains('btn-del')) {
                        s.present = !s.present; render(filter); queueSave(); 
                    }
                };
                list.appendChild(div);
            });
            document.getElementById('count').innerText = `${pCount} / ${h.students.length}`;
        }

        // --- Ø£Ø¯ÙˆØ§Øª ---
        function addStudent() {
            const n = document.getElementById('newStudentName').value.trim();
            if(n) {
                appData.halaqat[selectedHalaqaIdx].students.push({name:n, present:false, level:levelsList[0], surahIndex:113});
                document.getElementById('newStudentName').value=''; render(); queueSave();
            }
        }
        function deleteStudent(idx, e) {
            e.stopPropagation();
            if(confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) { appData.halaqat[selectedHalaqaIdx].students.splice(idx, 1); render(); queueSave(); }
        }
        function updateLevel(idx, val) { appData.halaqat[selectedHalaqaIdx].students[idx].level=val; queueSave(); }
        function updateSurah(idx, val) { appData.halaqat[selectedHalaqaIdx].students[idx].surahIndex=parseInt(val); queueSave(); }
        function stepSurah(idx, dir) {
            let s = appData.halaqat[selectedHalaqaIdx].students[idx];
            let next = (s.surahIndex||113)+dir;
            if(next>=0 && next<surahList.length) { s.surahIndex=next; render(); queueSave(); }
        }
        function resetDay() {
            if(confirm("ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…ØŸ")) { appData.halaqat[selectedHalaqaIdx].students.forEach(s=>s.present=false); render(); queueSave(); }
        }
        function logout() { location.reload(); }
        function changeCurrentPin() {
            const newPin = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
            if(newPin) { appData.halaqat[selectedHalaqaIdx].pin = newPin; saveData(); alert("ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±!"); }
        }
        function deleteCurrentHalaqa() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!")) {
                appData.halaqat.splice(selectedHalaqaIdx, 1);
                saveData(); alert("ØªÙ… Ø§Ù„Ø­Ø°Ù"); logout();
            }
        }

        // --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ---
        function openBulkModal() { document.getElementById('bulkModal').style.display = 'flex'; }
        function closeBulkModal() { document.getElementById('bulkModal').style.display = 'none'; }
        function saveBulkData() {
            const txt = document.getElementById('bulkText').value;
            const names = txt.split('\n');
            names.forEach(n => {
                if(n.trim()) appData.halaqat[selectedHalaqaIdx].students.push({name:n.trim(), present:false, level:levelsList[0], surahIndex:113});
            });
            document.getElementById('bulkText').value=''; closeBulkModal(); render(); queueSave();
        }

        function printPDF() {
            const h = appData.halaqat[selectedHalaqaIdx];
            const now = new Date();
            document.getElementById('print-report-no').innerText = `REP-${now.getTime()}`;
            document.getElementById('print-date').innerText = now.toLocaleDateString('ar-DZ');
            document.getElementById('print-stats').innerText = `Ø­Ø¶ÙˆØ±: ${h.students.filter(s=>s.present).length} / ${h.students.length}`;
            
            let cP=0, cM=0, cS=0, cU=0;
            h.students.forEach(s => {
                let l = s.level||"";
                if(l.includes("Ø¥Ø¨ØªØ¯Ø§Ø¦ÙŠ")) cP++; else if(l.includes("Ù…ØªÙˆØ³Ø·")) cM++; else if(l.includes("Ø«Ø§Ù†ÙˆÙŠ")) cS++; else if(l.includes("Ø¬Ø§Ù…Ø¹ÙŠ")) cU++;
            });
            document.getElementById('c-prim').innerText=cP; document.getElementById('c-mid').innerText=cM; document.getElementById('c-sec').innerText=cS; document.getElementById('c-univ').innerText=cU;

            const tbody = document.getElementById('print-body');
            tbody.innerHTML = '';
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const sorted = [...h.students].sort((a,b) => (a.present !== b.present) ? (a.present?-1:1) : a.name.localeCompare(b.name,'ar'));
            let c = 1;
            sorted.forEach(s => {
                const st = s.present ? 'Ø­Ø§Ø¶Ø±' : 'ØºÙŠØ§Ø¨';
                const col = s.present ? '#27ae60' : '#c0392b';
                tbody.innerHTML += `<tr><td>${c++}</td><td style="text-align:right; font-weight:bold;">${s.name}</td><td>${s.level||'-'}</td><td style="color:${col}; font-weight:bold;">${st}</td><td>${surahList[s.surahIndex||113]}</td><td></td></tr>`;
            });
            window.print();
        }
    </script>
</body>
</html>
